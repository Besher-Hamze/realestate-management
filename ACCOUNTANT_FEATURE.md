# ميزة المحاسب - إنشاء مصروفات من طلبات الخدمة

## نظرة عامة

تم إضافة ميزة جديدة للمحاسبين تسمح لهم بإنشاء مصروفات تلقائياً من طلبات الخدمة المكتملة. هذه الميزة تبسط عملية المحاسبة وتقلل من الأخطاء اليدوية.

## الميزات الرئيسية

### 1. تبويب جديد للمحاسبين

- تم إضافة تبويب "إنشاء مصروفات من طلبات الخدمة" في القائمة الجانبية
- متاح فقط للمستخدمين ذوي دور "محاسب" (accountant)

### 2. عرض طلبات الخدمة المكتملة

- عرض جميع طلبات الخدمة المكتملة التي لها سعر محدد
- عرض تفاصيل شاملة لكل طلب خدمة:
  - رقم الطلب ونوع الخدمة
  - الوصف والسعر
  - معلومات الوحدة والمبنى
  - معلومات المستأجر والمالك
  - تاريخ الإكمال

### 3. نظام تصفية متقدم

- تصفية حسب نوع الخدمة (صيانة، مالي، إداري)
- بحث نصي في الوصف واسم المستخدم ورقم الوحدة
- تصفية حسب نطاق السعر (حد أدنى وأقصى)

### 4. إنشاء المصروفات

- إنشاء مصروف جديد من طلب الخدمة
- تحديد من يجب عليه الدفع (المالك أو المستأجر)
- ملاحظات إضافية اختيارية
- ملء البيانات تلقائياً:
  - المبنى والوحدة
  - نوع المصروف (صيانة أو حسب نوع الطلب)
  - المبلغ (من سعر الخدمة)
  - تاريخ المصروف (التاريخ الحالي)
  - المرفق (من مرفق الإكمال)

## الملفات الجديدة

### الصفحات

- `src/app/dashboard/accountant/service-expenses/page.tsx` - الصفحة الرئيسية

### المكونات

- `src/components/accountant/ServiceOrderExpenseList.tsx` - قائمة طلبات الخدمة
- `src/components/accountant/ServiceOrderExpenseFilter.tsx` - فلاتر البحث
- `src/components/accountant/ServiceOrderExpenseModal.tsx` - نافذة إنشاء المصروف

### API

- تم إضافة دالة `createFromServiceOrder` في `expensesApi`

## كيفية الاستخدام

### 1. الوصول للميزة

1. تسجيل الدخول بحساب محاسب
2. الانتقال إلى "إنشاء مصروفات من طلبات الخدمة" من القائمة الجانبية

### 2. عرض طلبات الخدمة

- ستظهر جميع طلبات الخدمة المكتملة
- استخدام الفلاتر لتضييق النتائج
- عرض الإحصائيات في أعلى الصفحة

### 3. إنشاء مصروف

1. الضغط على "إنشاء مصروف" لأي طلب خدمة
2. تحديد من يجب عليه الدفع (المالك أو المستأجر)
3. إضافة ملاحظات إضافية (اختياري)
4. مراجعة البيانات المملوءة تلقائياً
5. الضغط على "إنشاء المصروف"

## المتطلبات التقنية

### البيانات المطلوبة

- طلب خدمة مكتمل (`status: 'completed'`)
- سعر الخدمة محدد (`servicePrice`)
- معلومات الوحدة والمبنى
- معلومات المستأجر والمالك

### API Endpoints

#### 1. جلب طلبات الخدمة المكتملة

```
GET /api/expenses/service-orders/completed-for-expense
```

#### 2. إنشاء مصروف من طلب خدمة

```
POST /api/expenses/create-from-service-order/:serviceOrderId
```

**Body:**

```json
{
  "responsibleParty": "owner" | "tenant",
  "notes": "string (optional)"
}
```

## الأمان والصلاحيات

- متاح فقط للمستخدمين ذوي دور "محاسب"
- يمكن للمحاسبين الوصول لجميع طلبات الخدمة المكتملة
- لا يمكن إنشاء مصروفات من طلبات غير مكتملة

## الفوائد

1. **توفير الوقت**: إنشاء مصروفات تلقائياً بدلاً من الإدخال اليدوي
2. **تقليل الأخطاء**: البيانات المملوءة تلقائياً من طلب الخدمة
3. **تتبع أفضل**: ربط المصروفات بطلبات الخدمة
4. **إدارة مالية محسنة**: تتبع التكاليف بدقة

## التطوير المستقبلي

- إضافة تقارير مالية للمحاسبين
- تصدير البيانات إلى Excel
- إشعارات للمصروفات الجديدة
- دعم المرفقات المتعددة
